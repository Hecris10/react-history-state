name: ğŸ”’ Security Checks

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run security checks weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'

jobs:
  # Dependency vulnerability scanning
  dependency-scan:
    name: ğŸ” Dependency Scan
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ” Run security audit
        run: |
          echo "ğŸ” Running pnpm audit..."
          pnpm audit --audit-level moderate

      - name: ğŸ“Š Check for known vulnerabilities
        run: |
          echo "ğŸ“Š Checking for known vulnerabilities..."
          npx audit-ci --moderate

  # CodeQL analysis for code security
  codeql-analysis:
    name: ğŸ”¬ CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      matrix:
        language: ['javascript']

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”¬ Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: ${{ matrix.language }}

      - name: ğŸ—ï¸ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ Build project
        run: pnpm run build

      - name: ğŸ”¬ Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

  # License compliance check
  license-check:
    name: âš–ï¸ License Check
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: âš–ï¸ Check licenses
        run: |
          echo "âš–ï¸ Installing license checker..."
          npx license-checker --summary --excludePrivatePackages

          echo "ğŸ“‹ Checking for problematic licenses..."
          npx license-checker --failOn "GPL;AGPL;LGPL;CPAL;OSL;EPL;MPL" --excludePrivatePackages

  # Bundle size check to prevent supply chain attacks
  bundle-analysis:
    name: ğŸ“¦ Bundle Analysis
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ Build library
        run: pnpm run build

      - name: ğŸ“Š Analyze bundle size
        run: |
          echo "ğŸ“¦ Bundle size analysis:"
          ls -lah dist/

          # Check if bundle sizes are reasonable
          for file in dist/*.js; do
            if [[ -f "$file" ]]; then
              SIZE=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
              echo "ğŸ“ $file: $SIZE bytes"

              # Warn if any file is over 100KB (reasonable for a React hook library)
              if [[ $SIZE -gt 102400 ]]; then
                echo "âš ï¸ Warning: $file is larger than 100KB ($SIZE bytes)"
                echo "This might indicate a supply chain issue or bundling problem"
              fi
            fi
          done

      - name: ğŸ” Check for suspicious patterns
        run: |
          echo "ğŸ” Scanning for suspicious patterns in built files..."

          # Check for common suspicious patterns
          SUSPICIOUS_PATTERNS=(
            "eval\("
            "Function\("
            "XMLHttpRequest"
            "fetch\("
            "\.send\("
            "btoa\("
            "atob\("
            "crypto\."
            "require\(['\"]child_process['\"]"
            "require\(['\"]fs['\"]"
            "require\(['\"]http['\"]"
            "require\(['\"]https['\"]"
          )

          for pattern in "${SUSPICIOUS_PATTERNS[@]}"; do
            if grep -r "$pattern" dist/ 2>/dev/null; then
              echo "âš ï¸ Suspicious pattern found: $pattern"
              echo "This should be investigated for potential security issues"
            fi
          done

          echo "âœ… Bundle security check complete"

  # Collect security results
  security-complete:
    name: âœ… Security Checks Complete
    runs-on: ubuntu-latest
    needs: [dependency-scan, codeql-analysis, license-check, bundle-analysis]
    if: always()

    steps:
      - name: ğŸ“Š Security summary
        run: |
          echo "ğŸ”’ Security check results:"
          echo "ğŸ” Dependency scan: ${{ needs.dependency-scan.result }}"
          echo "ğŸ”¬ CodeQL analysis: ${{ needs.codeql-analysis.result }}"
          echo "âš–ï¸ License check: ${{ needs.license-check.result }}"
          echo "ğŸ“¦ Bundle analysis: ${{ needs.bundle-analysis.result }}"

          if [[ "${{ needs.dependency-scan.result }}" == "failure" ]] || [[ "${{ needs.codeql-analysis.result }}" == "failure" ]] || [[ "${{ needs.license-check.result }}" == "failure" ]] || [[ "${{ needs.bundle-analysis.result }}" == "failure" ]]; then
            echo "âŒ Some security checks failed!"
            exit 1
          else
            echo "âœ… All security checks passed! ğŸ”’"
          fi
